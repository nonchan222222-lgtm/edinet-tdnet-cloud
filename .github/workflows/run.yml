name: edinet-tdnet cloud run

on:
  # 手動実行時の入力フォーム（＝検索窓）
  workflow_dispatch:
    inputs:
      start:
        description: '開始日 YYYY-MM-DD'
        required: true
        default: '2025-08-12'
      end:
        description: '終了日 YYYY-MM-DD'
        required: true
        default: '2025-08-14'
      codes:
        description: '会社名/4桁コード(カンマ区切り) 例: 7203,ソニー'
        required: false
        default: ''
      filetypes:
        description: 'EDINETファイル種別（csv,pdf,xbrl をカンマ区切り）'
        required: false
        default: 'pdf'
      include_yuho:
        description: '有価証券報告書を含めるか? yes/no'
        required: false
        default: 'yes'
      include_q:
        description: '四半期報告書を含めるか? yes/no'
        required: false
        default: 'no'
      tdnet:
        description: 'TDnet(決算短信)を取得するか? yes/no'
        required: false
        default: 'yes'

permissions:
  contents: read

concurrency:
  group: edinet-tdnet
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---- 取得本体 ----
      - name: Run downloader
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
          DEFAULT_CODES:  ${{ secrets.DEFAULT_CODES }}
        run: |
          set -e
          START="${{ github.event.inputs.start }}"
          END="${{ github.event.inputs.end }}"
          CODES="${{ github.event.inputs.codes }}"
          FILES="${{ github.event.inputs.filetypes }}"
          YUHO="${{ github.event.inputs.include_yuho }}"
          QTR="${{ github.event.inputs.include_q }}"
          TD="${{ github.event.inputs.tdnet }}"

          # フォーム未入力時の保険
          if [ -z "$CODES" ] && [ -n "$DEFAULT_CODES" ]; then CODES="$DEFAULT_CODES"; fi

          # 実行
          python edinet_tdnet_downloader.py \
            --start "$START" --end "$END" \
            --edinet-filetypes "$FILES" \
            --include-yuho "$YUHO" --include-quarter "$QTR" \
            --tdnet "$TD" \
            --codes "$CODES"

      # ---- 成果物アップロード（0件でもREADMEを入れて出す）----
      - name: Ensure downloads folder exists
        run: |
          mkdir -p downloads
          if [ ! -e downloads/README.txt ]; then
            echo "No files retrieved in this run. Check dates/codes or API key." > downloads/README.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: outputs-${{ github.run_id }}
          path: downloads
          if-no-files-found: warn
          retention-days: 90
          
